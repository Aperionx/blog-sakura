(function(){var e=(function(){'use strict';var We=tinymce.util.Tools.resolve('tinymce.PluginManager'),m=tinymce.util.Tools.resolve('tinymce.Env'),t=tinymce.util.Tools.resolve('tinymce.util.Tools'),Ie=function(e){return e.getParam('media_scripts')},Je=function(e){return e.getParam('audio_template_callback')},Be=function(e){return e.getParam('video_template_callback')},Ge=function(e){return e.getParam('media_live_embeds',!0)},et=function(e){return e.getParam('media_filter_html',!0)},tt=function(e){return e.getParam('media_url_resolver')},rt=function(e){return e.getParam('media_alt_source',!0)},it=function(e){return e.getParam('media_poster',!0)},at=function(e){return e.getParam('media_dimensions',!0)},e={getScripts:Ie,getAudioTemplateCallback:Je,getVideoTemplateCallback:Be,hasLiveEmbeds:Ge,shouldFilterHtml:et,getUrlResolver:tt,hasAltSource:rt,hasPoster:it,hasDimensions:at};var l=tinymce.util.Tools.resolve('tinymce.html.SaxParser'),D=tinymce.util.Tools.resolve('tinymce.dom.DOMUtils'),Ue=function(e,t){if(e){for(var r=0;r<e.length;r++){if(t.indexOf(e[r].filter)!==-1){return e[r]}}}},g={getVideoScriptMatch:Ue};var Ve=function(e){return e.replace(/px$/,'')},Re=function(e){return/^[0-9.]+$/.test(e)?e+'px':e},P=function(e){return function(t){return t?Ve(t.style[e]):''}},O=function(e){return function(t,r){if(t){t.style[e]=Re(r)}}},a={getMaxWidth:P('maxWidth'),getMaxHeight:P('maxHeight'),setMaxWidth:O('maxWidth'),setMaxHeight:O('maxHeight')};var p=D.DOM,N=function(e){return p.getAttrib(e,'data-ephox-embed-iri')},Oe=function(e){var t=p.createFragment(e);return N(t.firstChild)!==''},De=function(e,r){var i={};l({validate:!1,allow_conditional_comments:!0,special:'script,noscript',start:function(r,a){if(!i.source1&&r==='param'){i.source1=a.map.movie};if(r==='iframe'||r==='object'||r==='embed'||r==='video'||r==='audio'){if(!i.type){i.type=r};i=t.extend(a.map,i)};if(r==='script'){var n=g.getVideoScriptMatch(e,a.map.src);if(!n){return};i={type:'script',source1:a.map.src,width:n.width,height:n.height}};if(r==='source'){if(!i.source1){i.source1=a.map.src}
else if(!i.source2){i.source2=a.map.src}};if(r==='img'&&!i.poster){i.poster=a.map.src}}}).parse(r);i.source1=i.source1||i.src||i.data;i.source2=i.source2||'';i.poster=i.poster||'';return i},Ee=function(e){var r=p.createFragment(e),t=r.firstChild;return{type:'ephox-embed-iri',source1:N(t),source2:'',poster:'',width:a.getMaxWidth(t),height:a.getMaxHeight(t)}},Le=function(e,t){return Oe(t)?Ee(t):De(e,t)},u={htmlToData:Le};var F=tinymce.util.Tools.resolve('tinymce.util.Promise'),Pe=function(e){var i={mp3:'audio/mpeg',wav:'audio/wav',mp4:'video/mp4',webm:'video/webm',ogg:'video/ogg',};var r=e.toLowerCase().split('.').pop(),t=i[r];return t?t:''},k={guess:Pe};var f=tinymce.util.Tools.resolve('tinymce.html.Writer'),A=tinymce.util.Tools.resolve('tinymce.html.Schema'),h=D.DOM,r=function(e,t){var r,a,i,n;for(r in t){i=''+t[r];if(e.map[r]){a=e.length;while(a--){n=e[a];if(n.name===r){if(i){e.map[r]=i;n.value=i}
else{delete e.map[r];e.splice(a,1)}}}}
else if(i){e.push({name:r,value:i});e.map[r]=i}}},ze=function(e){var t=f(),r=l(t);r.parse(e);return t.getContent()},Ae=function(e,t,i){var a=f(),n=0,o;l({validate:!1,allow_conditional_comments:!0,special:'script,noscript',comment:function(e){a.comment(e)},cdata:function(e){a.cdata(e)},text:function(e,t){a.text(e,t)},start:function(e,c,s){switch(e){case'video':case'object':case'embed':case'img':case'iframe':if(t.height!==undefined&&t.width!==undefined){r(c,{width:t.width,height:t.height})};break};if(i){switch(e){case'video':r(c,{poster:t.poster,src:''});if(t.source2){r(c,{src:''})};break;case'iframe':r(c,{src:t.source1});break;case'source':n++;if(n<=2){r(c,{src:t['source'+n],type:t['source'+n+'mime']});if(!t['source'+n]){return}};break;case'img':if(!t.poster){return};o=!0;break}};a.start(e,c,s)},end:function(e){if(e==='video'&&i){for(var c=1;c<=2;c++){if(t['source'+c]){var u=[];u.map={};if(n<c){r(u,{src:t['source'+c],type:t['source'+c+'mime']});a.start('source',u,!0)}}}};if(t.poster&&e==='object'&&i&&!o){var s=[];s.map={};r(s,{src:t.poster,width:t.width,height:t.height});a.start('img',s,!0)};a.end(e)}},A({})).parse(e);return a.getContent()},Fe=function(e){var t=h.createFragment(e);return h.getAttrib(t.firstChild,'data-ephox-embed-iri')!==''},ke=function(e,t){var i=h.createFragment(e),r=i.firstChild;a.setMaxWidth(r,t.width);a.setMaxHeight(r,t.height);return ze(r.outerHTML)},Ne=function(e,t,r){return Fe(e)?ke(e,t):Ae(e,t,r)},s={updateHtml:Ne};var He=[{regex:/youtu\.be\/([\w\-_\?&=.]+)/i,type:'iframe',w:560,h:314,url:'//www.youtube.com/embed/$1',allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)(&([a-z0-9&=\-_]+))?/i,type:'iframe',w:560,h:314,url:'//www.youtube.com/embed/$2?$4',allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\?&=\-_]+)/i,type:'iframe',w:560,h:314,url:'//www.youtube.com/embed/$1',allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:'iframe',w:425,h:350,url:'//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc',allowFullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:'iframe',w:425,h:350,url:'//player.vimeo.com/video/$2?title=0&amp;byline=0',allowFullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:'iframe',w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:'iframe',w:480,h:270,url:'//www.dailymotion.com/embed/video/$1',allowFullscreen:!0},{regex:/dai\.ly\/([^_]+)/,type:'iframe',w:480,h:270,url:'//www.dailymotion.com/embed/video/$1',allowFullscreen:!0}];var we=function(e,t){var i=e.regex.exec(t),a=e.url,n=function(e){a=a.replace('$'+e,function(){return i[e]?i[e]:''})};for(var r=0;r<i.length;r++){n(r)};return a.replace(/\?$/,'')},ye=function(e){var r=He.filter(function(t){return t.regex.test(e)});if(r.length>0){return t.extend({},r[0],{url:we(r[0],e)})}
else{return null}},xe=function(e){var t=e.allowFullscreen?' allowFullscreen="1"':'';return'<iframe src="'+e.source1+'" width="'+e.width+'" height="'+e.height+'"'+t+'></iframe>'},Se=function(e,t){if(t){return t(e)}
else{return'<audio controls="controls" src="'+e.source1+'">'+(e.source2?'\n<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':'')+' />\n':'')+'</audio>'}},Ce=function(e,t){if(t){return t(e)}
else{return'<video width="'+e.width+'" height="'+e.height+'"'+(e.poster?' poster="'+e.poster+'"':'')+' controls="controls">\n<source src="'+e.source1+'"'+(e.source1mime?' type="'+e.source1mime+'"':'')+' />\n'+(e.source2?'<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':'')+' />\n':'')+'</video>'}},Me=function(e){return'<script src="'+e.source1+'"></script>'},je=function(r,a){var i=t.extend({},a);if(!i.source1){t.extend(i,u.htmlToData(e.getScripts(r),i.embed));if(!i.source1){return''}};if(!i.source2){i.source2=''};if(!i.poster){i.poster=''};i.source1=r.convertURL(i.source1,'source');i.source2=r.convertURL(i.source2,'source');i.source1mime=k.guess(i.source1);i.source2mime=k.guess(i.source2);i.poster=r.convertURL(i.poster,'poster');var n=ye(i.source1);if(n){i.source1=n.url;i.type=n.type;i.allowFullscreen=n.allowFullscreen;i.width=i.width||n.w;i.height=i.height||n.h};if(i.embed){return s.updateHtml(i.embed,i,!0)}
else{var o=g.getVideoScriptMatch(e.getScripts(r),i.source1);if(o){i.type='script';i.width=o.width;i.height=o.height};var c=e.getAudioTemplateCallback(r),l=e.getVideoTemplateCallback(r);i.width=i.width||300;i.height=i.height||150;t.each(i,function(e,t){i[t]=r.dom.encode(e)});if(i.type==='iframe'){return xe(i)}
else if(i.source1mime.indexOf('audio')!==-1){return Se(i,c)}
else if(i.type==='script'){return Me(i)}
else{return Ce(i,l)}}},Te={dataToHtml:je};var c={};var pe=function(e,t,r){return new F(function(i,a){var n=function(r){if(r.html){c[e.source1]=r};return i({url:e.source1,html:r.html?r.html:t(e)})};if(c[e.source1]){n(c[e.source1])}
else{r({url:e.source1},n,a)}})},ge=function(e,t){return new F(function(r){r({html:t(e),url:e.source1})})},z=function(e){return function(t){return Te.dataToHtml(e,t)}},ve=function(t,r){var i=e.getUrlResolver(t);return i?pe(r,z(t),i):ge(r,z(t))},be=function(e){return c.hasOwnProperty(e)},o={getEmbedHtml:ve,isCached:be};var j=function(e,t){e.state.set('oldVal',e.value());t.state.set('oldVal',t.value())},T=function(e,t){var r=e.find('#width')[0],i=e.find('#height')[0],a=e.find('#constrain')[0];if(r&&i&&a){t(r,i,a.checked())}},de=function(e,t,r){var n=e.state.get('oldVal'),o=t.state.get('oldVal'),i=e.value(),a=t.value();if(r&&n&&o&&i&&a){if(i!==n){a=Math.round(i/n*a);if(!isNaN(a)){t.value(a)}}
else{i=Math.round(a/o*i);if(!isNaN(i)){e.value(i)}}};j(e,t)},fe=function(e){T(e,j)},H=function(e){T(e,de)},he=function(e){var t=function(){e(function(e){H(e)})};return{type:'container',label:'Dimensions',layout:'flex',align:'center',spacing:5,items:[{name:'width',type:'textbox',maxLength:5,size:5,onchange:t,ariaLabel:'Width'},{type:'label',text:'x'},{name:'height',type:'textbox',maxLength:5,size:5,onchange:t,ariaLabel:'Height'},{name:'constrain',type:'checkbox',checked:!0,text:'Constrain proportions'}]}},n={createUi:he,syncSize:fe,updateSize:H};var ne=m.ie&&m.ie<=8?'onChange':'onInput',d=function(e){return function(t){var r=t&&t.msg?'Media embed handler error: '+t.msg:'Media embed handler threw unknown error.';e.notificationManager.open({type:'error',text:r})}},oe=function(t){var r=t.selection.getNode(),i=r.getAttribute('data-ephox-embed-iri');if(i){return{'source1':i,'data-ephox-embed-iri':i,'width':a.getMaxWidth(r),'height':a.getMaxHeight(r)}};return r.getAttribute('data-mce-object')?u.htmlToData(e.getScripts(t),t.serializer.serialize(r,{selection:!0})):{}},ce=function(e){var t=e.selection.getNode();if(t.getAttribute('data-mce-object')||t.getAttribute('data-ephox-embed-iri')){return e.selection.getContent()}},S=function(r,i){return function(a){var o=a.html,c=r.find('#embed')[0],s=t.extend(u.htmlToData(e.getScripts(i),o),{source1:a.url});r.fromJSON(s);if(c){c.value(o);n.updateSize(r)}}},se=function(e,t){var i,r,a=e.dom.select('img[data-mce-object]');for(i=0;i<t.length;i++){for(r=a.length-1;r>=0;r--){if(t[i]===a[r]){a.splice(r,1)}}};e.selection.select(a[0])},C=function(e,t){var r=e.dom.select('img[data-mce-object]');e.insertContent(t);se(e,r);e.nodeChanged()},ue=function(e,t){var r=e.toJSON();r.embed=s.updateHtml(r.embed,r);if(r.embed&&o.isCached(r.source1)){C(t,r.embed)}
else{o.getEmbedHtml(t,r).then(function(e){C(t,e.html)}).catch(d(t))}},le=function(e,r){t.each(r,function(t,r){e.find('#'+r).value(t)})},me=function(r){var i,a,f=[{name:'source1',type:'filepicker',filetype:'media',size:40,autofocus:!0,label:'Source',onpaste:function(){setTimeout(function(){o.getEmbedHtml(r,i.toJSON()).then(S(i,r)).catch(d(r))},1)},onchange:function(e){o.getEmbedHtml(r,i.toJSON()).then(S(i,r)).catch(d(r));le(i,e.meta)},onbeforecall:function(e){e.meta=i.toJSON()}}];var c=[],g=function(e){e(i);a=i.toJSON();i.find('#embed').value(s.updateHtml(a.embed,a))};if(e.hasAltSource(r)){c.push({name:'source2',type:'filepicker',filetype:'media',size:40,label:'Alternative source'})};if(e.hasPoster(r)){c.push({name:'poster',type:'filepicker',filetype:'image',size:40,label:'Poster'})};if(e.hasDimensions(r)){var p=n.createUi(g);f.push(p)};a=oe(r);var m={id:'mcemediasource',type:'textbox',flex:1,name:'embed',value:ce(r),multiline:!0,rows:5,label:'Source'};var h=function(){a=t.extend({},u.htmlToData(e.getScripts(r),this.value()));this.parent().parent().fromJSON(a)};m[ne]=h;var l=[{title:'General',type:'form',items:f},{title:'Embed',type:'container',layout:'flex',direction:'column',align:'stretch',padding:10,spacing:10,items:[{type:'label',text:'Paste your embed code below:',forId:'mcemediasource'},m]}];if(c.length>0){l.push({title:'Advanced',type:'form',items:c})};i=r.windowManager.open({title:'Insert/edit media',data:a,bodyType:'tabpanel',body:l,onSubmit:function(){n.updateSize(i);ue(i,r)}});n.syncSize(i)},M={showDialog:me};var ie=function(e){var t=function(){M.showDialog(e)};return{showDialog:t}},ae={get:ie};var te=function(e){var t=function(){M.showDialog(e)};e.addCommand('mceMedia',t)},re={register:te};var i=tinymce.util.Tools.resolve('tinymce.html.Node'),ee=function(t,r){if(e.shouldFilterHtml(t)===!1){return r};var i=f(),a;l({validate:!1,allow_conditional_comments:!1,special:'script,noscript',comment:function(e){i.comment(e)},cdata:function(e){i.cdata(e)},text:function(e,t){i.text(e,t)},start:function(e,r,n){a=!0;if(e==='script'||e==='noscript'){return};for(var o=0;o<r.length;o++){if(r[o].name.indexOf('on')===0){return};if(r[o].name==='style'){r[o].value=t.dom.serializeStyle(t.dom.parseStyle(r[o].value),e)}};i.start(e,r,n);a=!1},end:function(e){if(a){return};i.end(e)}},A({})).parse(r);return i.getContent()},x={sanitize:ee};var v=function(e,t){var r,a=t.name;r=new i('img',1);r.shortEnded=!0;w(e,t,r);r.attr({'width':t.attr('width')||'300','height':t.attr('height')||(a==='audio'?'30':'150'),'style':t.attr('style'),'src':m.transparentSrc,'data-mce-object':a,'class':'mce-object mce-object-'+a});return r},b=function(e,t){var r,a,n,o=t.name;r=new i('span',1);r.attr({'contentEditable':'false','style':t.attr('style'),'data-mce-object':o,'class':'mce-preview-object mce-object-'+o});w(e,t,r);a=new i(o,1);a.attr({src:t.attr('src'),allowfullscreen:t.attr('allowfullscreen'),style:t.attr('style'),class:t.attr('class'),width:t.attr('width'),height:t.attr('height'),frameborder:'0'});n=new i('span',1);n.attr('class','mce-shim');r.append(a);r.append(n);return r},w=function(e,t,r){var i,a,n,o,c;n=t.attributes;o=n.length;while(o--){i=n[o].name;a=n[o].value;if(i!=='width'&&i!=='height'&&i!=='style'){if(i==='data'||i==='src'){a=e.convertURL(a,i)};r.attr('data-mce-p-'+i,a)}};c=t.firstChild&&t.firstChild.value;if(c){r.attr('data-mce-html',escape(x.sanitize(e,c)));r.firstChild=null}},y=function(e){while(e=e.parent){if(e.attr('data-ephox-embed-iri')){return!0}};return!1},B=function(t){return function(r){var n=r.length,i,a;while(n--){i=r[n];if(!i.parent){continue};if(i.parent.attr('data-mce-object')){continue};if(i.name==='script'){a=g.getVideoScriptMatch(e.getScripts(t),i.attr('src'));if(!a){continue}};if(a){if(a.width){i.attr('width',a.width.toString())};if(a.height){i.attr('height',a.height.toString())}};if(i.name==='iframe'&&e.hasLiveEmbeds(t)&&m.ceFalse){if(!y(i)){i.replace(b(t,i))}}
else{if(!y(i)){i.replace(v(t,i))}}}}},G={createPreviewIframeNode:b,createPlaceholderNode:v,placeHolderConverter:B};var I=function(e){e.on('preInit',function(){var a=e.schema.getSpecialElements();t.each('video audio iframe object'.split(' '),function(e){a[e]=new RegExp('</'+e+'[^>]*>','gi')});var r=e.schema.getBoolAttrs();t.each('webkitallowfullscreen mozallowfullscreen allowfullscreen'.split(' '),function(e){r[e]={}});e.parser.addNodeFilter('iframe,video,audio,object,embed,script',G.placeHolderConverter(e));e.serializer.addAttributeFilter('data-mce-object',function(t,r){var f=t.length,a,n,c,s,l,u,o,m;while(f--){a=t[f];if(!a.parent){continue};o=a.attr(r);n=new i(o,1);if(o!=='audio'&&o!=='script'){m=a.attr('class');if(m&&m.indexOf('mce-preview-object')!==-1){n.attr({width:a.firstChild.attr('width'),height:a.firstChild.attr('height')})}
else{n.attr({width:a.attr('width'),height:a.attr('height')})}};n.attr({style:a.attr('style')});s=a.attributes;c=s.length;while(c--){var d=s[c].name;if(d.indexOf('data-mce-p-')===0){n.attr(d.substr(11),s[c].value)}};if(o==='script'){n.attr('type','text/javascript')};l=a.attr('data-mce-html');if(l){u=new i('#text',3);u.raw=!0;u.value=x.sanitize(e,unescape(l));n.append(u)};a.replace(n)}})});e.on('setContent',function(){e.$('span.mce-preview-object').each(function(t,r){var i=e.$(r);if(i.find('span.mce-shim',r).length===0){i.append('<span class="mce-shim"></span>')}})})},J={setup:I};var U=function(e){e.on('ResolveName',function(e){var t;if(e.target.nodeType===1&&(t=e.target.getAttribute('data-mce-object'))){e.name=t}})},W={setup:U};var V=function(e){e.on('click keyup',function(){var t=e.selection.getNode();if(t&&e.dom.hasClass(t,'mce-preview-object')){if(e.dom.getAttrib(t,'data-mce-selected')){t.setAttribute('data-mce-selected','2')}}});e.on('ObjectSelected',function(e){var t=e.target.getAttribute('data-mce-object');if(t==='audio'||t==='script'){e.preventDefault()}});e.on('objectResized',function(e){var r=e.target,t;if(r.getAttribute('data-mce-object')){t=r.getAttribute('data-mce-html');if(t){t=unescape(t);r.setAttribute('data-mce-html',escape(s.updateHtml(t,{width:e.width,height:e.height})))}}})},R={setup:V};var E=function(e){e.addButton('media',{tooltip:'Insert/edit media',cmd:'mceMedia',stateSelector:['img[data-mce-object]','span[data-mce-object]','div[data-ephox-embed-iri]']});e.addMenuItem('media',{icon:'media',text:'Media',cmd:'mceMedia',context:'insert',prependToContext:!0})},L={register:E};We.add('media',function(e){re.register(e);L.register(e);W.setup(e);J.setup(e);R.setup(e);return ae.get(e)});function nt(){};return nt}())})();